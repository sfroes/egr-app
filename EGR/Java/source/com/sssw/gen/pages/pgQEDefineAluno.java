// *** Generated Source File ***
// Portions Copyright (c) 1996-2001, SilverStream Software, Inc., All Rights Reserved

package com.sssw.gen.pages; // generated by SilverStream: do not edit

import java.awt.*;
import java.util.*;
import java.math.*;
import com.sssw.rt.gui.*;
import com.sssw.rt.util.*;
import com.sssw.rt.event.*;
import java.awt.event.*;
import com.sssw.rt.expr.*;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import com.sssw.shr.page.*;
import com.sssw.shr.http.AgiHttpServletRequest;
import com.sssw.shr.http.AgiHttpServletResponse;
import com.sssw.shr.http.AgoServletException;
import com.sssw.srv.api.*;
import com.sssw.srv.busobj.*;
import com.sssw.srv.mail.*;

public class pgQEDefineAluno extends AgpPage // generated by SilverStream: do not edit
	
	
	
	implements AgiEventLinkListener
{
	
	public com.sssw.gen.pages.pgPadraoCabecalho	pgPadraoCabecalho;
	public com.sssw.shr.page.AgpLabel	lblDN;
	public com.sssw.shr.page.AgpData	agpAluno;
	public com.sssw.shr.page.AgpData	agpCurso;
	public com.sssw.shr.page.AgpLabel	lblDataNasc;
	public com.sssw.shr.page.AgpLabel	lblCurso;
	public com.sssw.shr.page.AgpLabel	lblCodAluno;
	public com.sssw.shr.page.AgpLabel	lblNome;
	public com.sssw.shr.page.AgpTable	tabResultado;
	boolean bAlunoOK = true;	
	
	
	public com.sssw.shr.page.AgpLabel	lblDatNasc2;
	public com.sssw.shr.page.AgpLabel	lblSemestre;
	public com.sssw.shr.page.AgpLabel	lblCod_Curso;
	
	public com.sssw.shr.page.AgpLabel	lblTurno;
	public com.sssw.shr.page.AgpLabel	lblAno;
	
	
	
	
	public com.sssw.shr.page.AgpViewPanel	dvAluno;
	
	
	
	public com.sssw.shr.page.AgpTable	tabMolduraCentral;
	
	String sSISTEMA = "";
	String sPAGINA = "";

	public pgQEDefineAluno()
	{
		//==== Warning: SilverStream-generated method: do not edit. All changes will be lost ===
	} 
	public void init() throws Exception
	{
		//==== Warning: SilverStream-generated method: do not edit. All changes will be lost ===
		agData.setDataMode(AgoData.DATA_MODE_NORMAL);
		// Initialize tabMolduraCentral
			tabMolduraCentral = (com.sssw.shr.page.AgpTable) getControl("tabMolduraCentral");
		// Initialize dvAluno
			dvAluno = (com.sssw.shr.page.AgpViewPanel) getControl("dvAluno");
			dvAluno.setName("dvAluno");
		// Initialize lblCod_Curso
			lblCod_Curso = (com.sssw.shr.page.AgpLabel) getControl("lblCod_Curso");
		// Initialize lblTurno
			lblTurno = (com.sssw.shr.page.AgpLabel) getControl("lblTurno");
		// Initialize lblAno
			lblAno = (com.sssw.shr.page.AgpLabel) getControl("lblAno");
		// Initialize lblSemestre
			lblSemestre = (com.sssw.shr.page.AgpLabel) getControl("lblSemestre");
		// Initialize lblDatNasc2
			lblDatNasc2 = (com.sssw.shr.page.AgpLabel) getControl("lblDatNasc2");
		// Initialize tabResultado
			tabResultado = (com.sssw.shr.page.AgpTable) getControl("tabResultado");
		// Initialize lblCodAluno
			lblCodAluno = (com.sssw.shr.page.AgpLabel) getControl("lblCodAluno");
		// Initialize lblNome
			lblNome = (com.sssw.shr.page.AgpLabel) getControl("lblNome");
			{
				String LinkParameters[] = {"cod_aluno", "pessoa_nome"};
				lblNome.initLinkParameters(LinkParameters);
			}
		// Initialize lblDataNasc
			lblDataNasc = (com.sssw.shr.page.AgpLabel) getControl("lblDataNasc");
		// Initialize lblCurso
			lblCurso = (com.sssw.shr.page.AgpLabel) getControl("lblCurso");
		// Initialize agpAluno
			agpAluno = (com.sssw.shr.page.AgpData) getControl("agpAluno");
			agpAluno.setName("agpAluno");
			agpAluno.setExpressionCount(7);
			agpAluno.setExpression(0, 0, "cod_aluno", 0);
			agpAluno.setExpression(1, 1, "pessoa_nome", 1);
			agpAluno.setExpression(2, 2, "pes_datanasc", 2);
			agpAluno.setExpression(3, 3, "ano", 3);
			agpAluno.setExpression(4, 4, "semestre", 4);
			agpAluno.setExpression(5, 5, "cod_curso_oferta", 5);
			agpAluno.setExpression(6, 6, "cod_turno", 6);
		// Initialize agpCurso
			agpCurso = (com.sssw.shr.page.AgpData) getControl("agpCurso");
			agpCurso.setName("agpCurso");
			agpCurso.setDataSource("dsoDadosCurso");
			agpCurso.setPropertyName(0, "cod_curso_oferta");
			agpCurso.setPropertyName(1, "nom_curso");
		// Initialize lblDN
			lblDN = (com.sssw.shr.page.AgpLabel) getControl("lblDN");
		// Initialize pgPadraoCabecalho
			pgPadraoCabecalho = (com.sssw.gen.pages.pgPadraoCabecalho) getControl("pgPadraoCabecalho");

		addChildren();

		addBindings();

		return;
	}
	private void addChildren()
	{
		//==== Warning: SilverStream-generated method: do not edit. All changes will be lost ===
		lblNome.addAgiEventLinkListener(this);
	}
	protected void addBindings()
	{
		//==== Warning: SilverStream-generated method: do not edit. All changes will be lost ===
		agDataMgr.bindToExp(lblCod_Curso, "TEXT", "getText", "setText", 7);
		agDataMgr.bindToExp(lblTurno, "TEXT", "getText", "setText", 8);
		agDataMgr.bindToExp(lblAno, "TEXT", "getText", "setText", 9);
		agDataMgr.bindToExp(lblSemestre, "TEXT", "getText", "setText", 10);
		agDataMgr.bindToExp(lblDatNasc2, "TEXT", "getText", "setText", 11);
		agDataMgr.bindToExp(lblCodAluno, "TEXT", "getText", "setText", 12);
		agDataMgr.bindToExp(lblNome, "TEXT", "getText", "setText", 13);
		agDataMgr.bindToExp(lblNome, "LinkParameterValue", "getLinkParameterValue", "setLinkParameterValue", 0, 14);
		agDataMgr.bindToExp(lblNome, "LinkParameterValue", "getLinkParameterValue", "setLinkParameterValue", 1, 15);
		agDataMgr.bindToExp(lblDataNasc, "TEXT", "getText", "setText", 16);
		agDataMgr.bindToExp(lblDN, "TEXT", "getText", "setText", 17);
		addExpDependencies();
	}

	
protected void pageRequestEnd(AgiHttpServletRequest req, AgiHttpServletResponse res) throws Exception
	{
		// Configura o controle de cache
		Hashtable hs = new Hashtable();		
		hs.put("response", res);
		invokeBusinessObject("Util:boCacheConfig", hs);
	}


protected void pageLoaded(AgiHttpServletRequest req, AgiHttpServletResponse res) throws Exception
	{
	try
	{	
		sSISTEMA = getDatabase() + " - ";	
		sPAGINA = getPath().substring(getPath().lastIndexOf('/') + 1, getPath().lastIndexOf('.'));

//		btnEstilo.setProperty("CLASS", "botao");
		tabMolduraCentral.setProperty("CLASS", "borda");
	}
	catch(Exception e)
	{
		String sMETODO = " - pageLoaded";

		// CHAMA boEnivaMsgConsole
		Hashtable hs = new Hashtable();
		hs.put("pIdentificador", sSISTEMA + sPAGINA + sMETODO);
		hs.put("pException", e);
		invokeBusinessObject("Util:boEnviaMsgConsole", hs);
	}

}






protected void pageRequestBegin(AgiHttpServletRequest req, AgiHttpServletResponse res) throws Exception
	{
	
	try
	{	
		if( getSessionValue("vsCodAluno") == null )
		{
        	showPage("pgQELogin.html");
			return;
		}
		else
		{
			carregaAlunos();
		}
	}
	catch(Exception e)
	{
	    String sMETODO = " - Exception pageRequestBegin  ......";
	    // CHAMA boEnivaMsgConsole
	    Hashtable hs = new Hashtable();
	    hs.put("pIdentificador", sSISTEMA + sPAGINA + sMETODO);
	    hs.put("pException", e);
	    invokeBusinessObject("Util:boEnviaMsgConsole", hs);
	}
		
	}


	public Object ag_getValue(DataCursor cursor, int valueID, Object param1, Object param2)
	{
		//==== Warning: SilverStream-generated method: do not edit. All changes will be lost ===
		try
		{
			switch (valueID)
			{
				case 0:
					/* cod_aluno () vw_ss_aluno.cod_aluno*/
					return ((Integer) cursor.getProperty(0));

				case 1:
					/* pessoa_nome () vw_ss_aluno.pessoa_nome*/
					return ((String) cursor.getProperty(1));

				case 2:
					/* pes_datanasc () vw_ss_aluno.pes_datanasc*/
					return ((java.sql.Timestamp) cursor.getProperty(2));

				case 3:
					/* ano () vw_ss_aluno.ano*/
					return ((Short) cursor.getProperty(3));

				case 4:
					/* semestre () vw_ss_aluno.semestre*/
					return ((Short) cursor.getProperty(4));

				case 5:
					/* cod_curso_oferta () vw_ss_aluno.cod_curso_oferta*/
					return ((Integer) cursor.getProperty(5));

				case 6:
					/* cod_turno () vw_ss_aluno.cod_turno*/
					return ((Short) cursor.getProperty(6));

				case 7:
					/* lblCod_Curso () vw_ss_aluno.cod_curso_oferta*/
					return ((Integer) dvAluno.getProperty(3));

				case 8:
					/* lblTurno () vw_ss_aluno.cod_turno*/
					return ((Short) dvAluno.getProperty(5));

				case 9:
					/* lblAno () vw_ss_aluno.ano*/
					return ((Short) dvAluno.getProperty(7));

				case 10:
					/* lblSemestre () vw_ss_aluno.semestre*/
					return ((Short) dvAluno.getProperty(6));

				case 11:
					/* lblDatNasc2 () vw_ss_aluno.dat_nascimento*/
					return ((String) dvAluno.getProperty(4));

				case 12:
					/* lblCodAluno () vw_ss_aluno.cod_aluno*/
					return ((Integer) dvAluno.getProperty(2));

				case 13:
					/* lblNome () vw_ss_aluno.pessoa_nome*/
					return ((String) dvAluno.getProperty(0));

				case 14:
					/* lblNome () vw_ss_aluno.cod_aluno*/
					return ((Integer) dvAluno.getProperty(2));

				case 15:
					/* lblNome () vw_ss_aluno.pessoa_nome*/
					return ((String) dvAluno.getProperty(0));

				case 16:
					/* lblDataNasc () vw_ss_aluno.pes_datanasc*/
					return ((java.sql.Timestamp) dvAluno.getProperty(1));

				case 17:
					/* lblDN () format(vw_ss_aluno.pes_datanasc, "dd/MM/yyyy")*/
					return AgFormat.format(((java.sql.Timestamp) dvAluno.getProperty(1)), "dd/MM/yyyy", AgFormat.DEFAULT, AgFormat.DEFAULT, getLocale(), null);

				default:
					return null;
			}
		}
		catch (Throwable e)
		{
			return null;
		}
	}

	




























public void carregaAlunos()
		throws Exception
	{
	try
	{
		
		boolean temCod = false;

		String dataNasc = null;
		String nome     = null;
		String codAluno = null;
		String codCurso = null;
		String ano      = null; 
		String semestre = null;
		String turno    = null;

		if (getSessionValue("vsNomeAluno") != null)
			nome     = new String( "" + getSessionValue("vsNomeAluno"));
		if (getSessionValue("vsCodAluno") != null)
			codAluno = new String( "" + getSessionValue("vsCodAluno"));
		if (getSessionValue("vsCodCursoOferta") != null)
			codCurso = new String( "" + getSessionValue("vsCodCursoOferta"));
		if (getSessionValue("vsAno") != null)
			ano      = new String( "" + getSessionValue("vsAno")); 
		if (getSessionValue("vsSemestre") != null)
			semestre = new String( "" + getSessionValue("vsSemestre"));      	
		if (getSessionValue("vsTurno") != null)
			turno    = new String( "" + getSessionValue("vsTurno"));


        //agpCurso.query("vw_ss_curso.cod_curso_oferta = " + codCurso);
		Hashtable hsParam = new Hashtable(); 
		hsParam.put("sCodCurso",""+codCurso);	
			
		agpCurso.invokeQuery(hsParam);
		if(agpCurso.gotoFirst())
       	 lblCurso.setText(("" + agpCurso.getProperty("nom_curso")).trim()); 


		// Formata a Data
		StringBuffer sSQLData = new StringBuffer(); 

		if (getSessionValue("vsDataNasc") != null)
		{
			dataNasc = new String( "" + getSessionValue("vsDataNasc"));

			String sDia = new String(dataNasc.substring(0,2));
			String sMes = new String(dataNasc.substring(3,5));
			String sAno = new String(dataNasc.substring(6,10));
					
			if (sDia.length() < 2)
				sDia += "0" + sDia;
					
			if (sMes.length() < 2)
				sMes += "0" + sMes;
						
			sSQLData.append("" + sAno + "-" + sMes + "-" + sDia);				

		}



		if (codAluno != null)
			if ( ! codAluno.trim().equals(""))
				temCod = true;



		StringBuffer sSQL = new StringBuffer();     



		if (temCod)
		{
			sSQL.append("( vw_ss_aluno.pessoa_nome like '" + nome.trim() + "%' " + 
						" OR vw_ss_aluno.cod_aluno = " + codAluno +  " ) " + 
						" AND vw_ss_aluno.dat_nascimento = '" + sSQLData.toString() + "'");

			if ((ano != null) && (! ano.trim().equals("")))
				sSQL.append(" AND vw_ss_aluno.ano = " + ano.trim());

			if ((semestre != null) && (! semestre.trim().equals("")))
				sSQL.append(" AND vw_ss_aluno.semestre = " + semestre.trim());

			if (codCurso != null)
				sSQL.append(" AND vw_ss_aluno.cod_curso_oferta = " + codCurso.trim());

			if (turno != null)
				sSQL.append(" AND vw_ss_aluno.cod_turno = " + turno.trim());
		}
		else
		{
			sSQL.append(" vw_ss_aluno.pessoa_nome like '" + nome.trim() + "%' ");
			sSQL.append(" AND vw_ss_aluno.dat_nascimento = '" + sSQLData.toString().trim() + "'");

			if ((ano != null) && (! ano.trim().equals("")))
				sSQL.append(" AND vw_ss_aluno.ano = " + ano.trim());
			
			if ((semestre != null) && (! semestre.trim().equals("")))
				sSQL.append(" AND vw_ss_aluno.semestre = " + semestre.trim());

			if (codCurso != null)
				sSQL.append(" AND vw_ss_aluno.cod_curso_oferta = " + codCurso.trim());

			if (turno != null)
				sSQL.append(" AND vw_ss_aluno.cod_turno = " + turno.trim());

		}



		dvAluno.query(sSQL.toString());



		AgiRowCursor LinhaCorrente = (AgiRowCursor) dvAluno.getCurrentRowCursor();
	
		String cod_aluno = new String();
		String nom_aluno = new String();

		int cont = 0;

		if(LinhaCorrente.gotoFirst())
		{      
			cont ++;
			cod_aluno= "" + LinhaCorrente.getProperty("vw_ss_aluno.cod_aluno");      
			nom_aluno= "" + LinhaCorrente.getProperty("vw_ss_aluno.pessoa_nome");      
			while(LinhaCorrente.gotoNext())
			{
				cont++;
			} 
		}    
/*
		if(cont == 1)
		{
			setSessionValue("vsNomeAluno", nom_aluno);
			setSessionValue("vsCodAluno" , cod_aluno);

			showPage("pgQeQuestionario.html"); 

			return;
		}
		else if(cont == 0)
		{
			bAlunoOK = false;
			return;
		}*/
	
	}
	catch(Exception e)
	{
		e.toString();
		e.printStackTrace();

		String sMETODO = " - General.carregaAlunos";
		// CHAMA boEnivaMsgConsole
	    Hashtable hs = new Hashtable();
	    hs.put("pIdentificador", sSISTEMA + sPAGINA + sMETODO);
	    hs.put("pException", e);
	    invokeBusinessObject("Util:boEnviaMsgConsole", hs);
	}

	}
	protected void addExpDependencies()
	{
		//==== Warning: SilverStream-generated method: do not edit. All changes will be lost ===
		agDataMgr.addExpDataDependency(17, dvAluno, 1, false);
		agDataMgr.addExpDataDependency(16, dvAluno, 1, false);
		agDataMgr.addExpDataDependency(15, dvAluno, 0, false);
		agDataMgr.addExpDataDependency(14, dvAluno, 2, false);
		agDataMgr.addExpDataDependency(13, dvAluno, 0, false);
		agDataMgr.addExpDataDependency(12, dvAluno, 2, false);
		agDataMgr.addExpDataDependency(11, dvAluno, 4, false);
		agDataMgr.addExpDataDependency(10, dvAluno, 6, false);
		agDataMgr.addExpDataDependency(9, dvAluno, 7, false);
		agDataMgr.addExpDataDependency(8, dvAluno, 5, false);
		agDataMgr.addExpDataDependency(7, dvAluno, 3, false);
	}

	public void eventLinkPerformed(AgpEventLinkEvent evt) throws Exception
	{
		//==== Warning: SilverStream-generated method: do not edit. All changes will be lost ===
		Object src = evt.getSource();
		if (src == lblNome)
		{
			handle_lblNome_eventLinkPerformed(evt);
			return;
		}
	}

	









protected void pageGenerateBegin() throws Exception
	{
	try
	{
		if (! bAlunoOK)
		{
			bAlunoOK = true;
			agScriptHelper.alert("Usuario não encontrado, tente novamente.");
//			showPage("pgQELogin.html");
			agScriptHelper.openWindow("pgQELogin.html", "_top", "");
		}

	}
	catch(Exception e)
	{
	    String sMETODO = " - Exception pageGenerateBegin  ......";
	    // CHAMA boEnivaMsgConsole
	    Hashtable hs = new Hashtable();
	    hs.put("pIdentificador", sSISTEMA + sPAGINA + sMETODO);
	    hs.put("pException", e);
	    invokeBusinessObject("Util:boEnviaMsgConsole", hs);
	}
	}
	
	private void handle_lblNome_eventLinkPerformed(AgpEventLinkEvent evt)
		throws Exception
	
	{

    	String[] sCod_aluno = getCurrentRequest().getParameterValues("cod_aluno");
		String[] sNom_aluno = getCurrentRequest().getParameterValues("pessoa_nome");
 	
		setSessionValue("vsCodAluno", sCod_aluno[0]);
		setSessionValue("vsNomeAluno", sNom_aluno[0]);
		
		showPage("pgQeQuestionario.html"); 	
	}

}
